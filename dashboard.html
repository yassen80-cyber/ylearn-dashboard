<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ğŸ“ Ù„ÙˆØ­Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ - YLEARN</title>
<style>
  :root {
    --bg:#0b0f19; --card:#111827; --accent:#00b2ff; --ok:#00b258; --muted:#cbd5e1;
  }
  body {
    margin: 0; font-family: "Cairo", sans-serif; background: var(--bg); color: #fff;
  }
  header {
    background: var(--card); padding: 12px 16px;
    display: flex; justify-content: space-between; align-items: center;
  }
  header h1 { color: var(--accent); margin: 0; }
  .main { max-width: 1000px; margin: 18px auto; padding: 12px; }
  .banner {
    background: linear-gradient(45deg,#00b2ff,#16a34a);
    padding: 12px; border-radius: 10px; font-weight: 700;
  }
  .select-box {
    background:#1e2636; padding:12px; border-radius:10px; margin-top:12px;
  }
  select {
    width:100%; padding:10px; border-radius:8px; border:0;
    background:#0b0f19; color:#fff;
  }
  .course-grid {
    display:grid; grid-template-columns:repeat(auto-fill,minmax(260px,1fr));
    gap:12px; margin-top:14px;
  }
  .course-card {
    background:#1e2636; padding:12px; border-radius:10px; text-align:right;
  }
  .course-card h3 { color:var(--accent); margin:0; }
  .course-card p { color:var(--muted); margin:8px 0; }
  .buy-btn, .view-btn {
    border:0; color:#fff; padding:10px; border-radius:8px;
    width:100%; cursor:pointer; font-weight:600;
  }
  .buy-btn { background:var(--accent); }
  .view-btn { background:var(--ok); }
  #logoutBtn {
    background:linear-gradient(45deg,#e63946,#b91c1c);
    border:none;color:#fff;padding:10px 16px;border-radius:10px;
    font-weight:600;cursor:pointer;transition:all 0.25s ease-in-out;
  }
  #logoutBtn:hover {
    transform:scale(1.07);
    background:linear-gradient(45deg,#ef4444,#991b1b);
    box-shadow:0 4px 15px rgba(239,68,68,0.5);
  }

  /* Ù†Ø§ÙØ°Ø© Ø§Ù„Ø´Ø±Ø§Ø¡ */
  .modal {
    position:fixed; inset:0; background:rgba(0,0,0,0.7);
    display:none; align-items:center; justify-content:center;
  }
  .modal-box {
    background:var(--card); border-radius:14px; padding:20px;
    max-width:400px; width:90%; text-align:center;
  }
  .modal-box h3 { color:var(--accent); margin-bottom:10px; }
  .modal-box p { color:var(--muted); line-height:1.6; font-size:15px; }
  .modal-box input {
    width:90%; padding:8px; border-radius:8px; border:none; margin:10px 0;
    background:#0b0f19; color:#fff; text-align:center;
  }
  .modal-box button {
    background:var(--ok); border:none; padding:10px 16px;
    border-radius:8px; color:#fff; cursor:pointer;
  }
</style>
</head>
<body>
<header>
  <h1>ğŸ“ Ù„ÙˆØ­Ø© Ø§Ù„Ø·Ø§Ù„Ø¨</h1>
  <button id="logoutBtn">ğŸ”’ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
</header>

<div class="main">
  <div class="banner" id="bannerText">Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ! Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¯Ø±Ø³ ÙˆØ§Ø¨Ø¯Ø£ Ø±Ø­Ù„Ø© Ø§Ù„ØªØ¹Ù„Ù… ğŸš€</div>
  <div class="select-box">
    <label>Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¯Ø±Ø³:</label>
    <select id="teacherSelect"><option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¯Ø±Ø³ --</option></select>
  </div>
  <div id="coursesContainer" class="course-grid"></div>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø´Ø±Ø§Ø¡ -->
<div id="buyModal" class="modal">
  <div class="modal-box">
    <h3>ğŸ’³ Ø¥ØªÙ…Ø§Ù… Ø´Ø±Ø§Ø¡ Ø§Ù„ÙƒÙˆØ±Ø³</h3>
    <p id="coursePriceText"></p>
    <p>Ø·Ø±Ù‚ Ø§Ù„ØªØ­ÙˆÙŠÙ„:</p>
    <p>ğŸ“± Ø¥Ù†Ø³ØªØ§ Ø¨Ø§ÙŠ: <b>01274060642</b> (Ù‡Ø¯Ù‰ Ù…Ø­Ù…Ø¯)</p>
    <p>ğŸ’³ ÙÙŠØ²Ø§: <b>5484 4602 5334 6969</b> (Ù‡Ø¯Ù‰ Ù…Ø­Ù…Ø¯)</p>
    <p>ğŸ“¸ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­ÙˆÙŠÙ„ØŒ Ø£Ø±Ø³Ù„ Ø³ÙƒØ±ÙŠÙ† Ø´ÙˆØª Ø¹Ù„Ù‰ Ø±Ù‚Ù… ÙˆØ§ØªØ³Ø§Ø¨:
      <b>01221015966</b> Ù„Ø§Ø³ØªÙ„Ø§Ù… ÙƒÙˆØ¯ Ø§Ù„ØªÙØ¹ÙŠÙ„.</p>
    <hr style="border:1px solid #333;margin:10px 0;">
    <label>Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„ØªÙØ¹ÙŠÙ„:</label>
    <input type="text" id="activationCode" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ Ù‡Ù†Ø§">
    <button id="activateBtn">âœ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙƒÙˆØ±Ø³</button><br><br>
    <button onclick="closeBuyModal()" style="background:#e63946;">Ø¥ØºÙ„Ø§Ù‚</button>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
  import { getDatabase, ref, get, set, onValue, update } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDW80ZbwOB7QHHW76kSL9cqlzMoyPFZ7nI",
    authDomain: "ylearn-fe1fa.firebaseapp.com",
    databaseURL: "https://ylearn-fe1fa-default-rtdb.firebaseio.com",
    projectId: "ylearn-fe1fa",
    storageBucket: "ylearn-fe1fa.appspot.com",
    messagingSenderId: "1092852055944",
    appId: "1:1092852055944:web:85c3df7cf4c0cbcdca043d"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  const teacherSelect = document.getElementById('teacherSelect');
  const coursesContainer = document.getElementById('coursesContainer');
  const logoutBtn = document.getElementById('logoutBtn');
  const banner = document.getElementById('bannerText');

  const buyModal = document.getElementById('buyModal');
  const coursePriceText = document.getElementById('coursePriceText');
  const activationInput = document.getElementById('activationCode');
  const activateBtn = document.getElementById('activateBtn');

  let currentCourse = null;
  let currentUserId = null;

  logoutBtn.onclick = async () => {
    await signOut(auth);
    alert("âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­");
    window.location.href = "login.html";
  };

  window.closeBuyModal = () => buyModal.style.display = "none";

  onAuthStateChanged(auth, async (user) => {
    if (!user) return window.location.href = "login.html";
    currentUserId = user.uid;

    const studentSnap = await get(ref(db, `students/${user.uid}`));
    const studentData = studentSnap.exists() ? studentSnap.val() : {};
    const studentName = studentData.name || "Ø·Ø§Ù„Ø¨Ù†Ø§ Ø§Ù„Ø¹Ø²ÙŠØ²";
    banner.textContent = `Ù…Ø±Ø­Ø¨Ù‹Ø§ ${studentName}! Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¯Ø±Ø³ ÙˆØ§Ø¨Ø¯Ø£ Ø±Ø­Ù„ØªÙƒ ğŸš€`;

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠÙ†
    const teachersSnap = await get(ref(db, "teachers"));
    teacherSelect.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¯Ø±Ø³ --</option>';
    if (teachersSnap.exists()) {
      Object.entries(teachersSnap.val()).forEach(([id, t]) => {
        const opt = document.createElement("option");
        opt.value = id;
        opt.textContent = t.name;
        teacherSelect.appendChild(opt);
      });
    }

    teacherSelect.addEventListener("change", async () => {
      const teacherId = teacherSelect.value;
      coursesContainer.innerHTML = '';
      if (!teacherId) return;

      const coursesSnap = await get(ref(db, "courses"));
      if (!coursesSnap.exists()) return;
      const allCourses = coursesSnap.val();

      const purchasedSnap = await get(ref(db, `students/${user.uid}/purchased`));
      const purchased = purchasedSnap.exists() ? purchasedSnap.val() : {};

      Object.entries(allCourses).forEach(([courseId, c]) => {
        if (c.teacherId === teacherId) {
          const card = document.createElement("div");
          card.className = "course-card";
          const isPurchased = purchased[courseId] === true;
          card.innerHTML = `
            <h3>${c.name}</h3>
            <p>${c.description || "Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ"}</p>
            <p>ğŸ’° Ø§Ù„Ø³Ø¹Ø±: ${c.price} Ø¬Ù†ÙŠÙ‡</p>
            <button id="btn-${courseId}" class="${isPurchased ? "view-btn" : "buy-btn"}">
              ${isPurchased ? "âœ… Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙˆØ±Ø³" : "ğŸ›’ Ø§Ø´ØªØ±Ù Ø§Ù„ÙƒÙˆØ±Ø³"}
            </button>
          `;
          coursesContainer.appendChild(card);

          const btn = document.getElementById(`btn-${courseId}`);
          if (isPurchased) {
            btn.onclick = () => {
              if (c.url) window.open(c.url, "_blank");
              else alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø­ØªÙˆÙ‰ Ø¨Ø¹Ø¯.");
            };
          } else {
            btn.onclick = async () => {
              currentCourse = { id: courseId, name: c.name, price: c.price };
              coursePriceText.textContent = `Ø³Ø¹Ø± Ø§Ù„ÙƒÙˆØ±Ø³: ${c.price} Ø¬Ù†ÙŠÙ‡ Ù…ØµØ±ÙŠ`;
              buyModal.style.display = "flex";

              // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
              await set(ref(db, `unlockRequests/${user.uid}_${courseId}`), {
                studentName,
                studentId: user.uid,
                studentPhone: studentData.phone || "ØºÙŠØ± Ù…Ø³Ø¬Ù„",
                parentPhone: studentData.guardianPhone || "ØºÙŠØ± Ù…Ø³Ø¬Ù„",
                courseName: c.name,
                courseId,
                price: c.price,
                status: "pending",
                timestamp: new Date().toISOString()
              });
            };
          }
        }
      });
    });
  });

  // ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙƒÙˆØ±Ø³ Ø¨Ø§Ù„ÙƒÙˆØ¯
  activateBtn.onclick = async () => {
    const code = activationInput.value.trim();
    if (!code) return alert("âš ï¸ Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹");

    const codeSnap = await get(ref(db, `activationCodes/${code}`));
    if (!codeSnap.exists()) return alert("âŒ Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­");
    const data = codeSnap.val();

    if (data.status === "used") return alert("âŒ ØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ù…Ù† Ù‚Ø¨Ù„");

    if (data.studentId !== currentUserId) return alert("âŒ Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ù„Ø§ ÙŠØ®Øµ Ø­Ø³Ø§Ø¨Ùƒ");

    // ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙƒÙˆØ±Ø³
    await update(ref(db, `students/${currentUserId}/purchased/${data.courseId}`), true);
    await update(ref(db, `activationCodes/${code}`), { status: "used" });

    alert(`âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙƒÙˆØ±Ø³ "${data.courseName}" Ø¨Ù†Ø¬Ø§Ø­!`);
    buyModal.style.display = "none";
  };
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ğŸ“˜ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ÙƒÙˆØ±Ø³ - Ù…Ù†ØµØ© THE GIANT</title>
<style>
  body {margin:0;font-family:"Cairo",sans-serif;background:#0b0f19;color:#fff;min-height:100vh;}
  header {background:#111827;padding:1rem 2rem;display:flex;justify-content:space-between;align-items:center;box-shadow:0 0 10px rgba(0,0,0,0.3);}
  header h1 {color:#00b2ff;margin:0;font-size:1.3rem;}
  button {border:none;border-radius:8px;cursor:pointer;transition:0.3s;}
  button.back {background:#00b2ff;color:#fff;padding:0.6rem 1.2rem;}
  button:hover {opacity:0.9;}
  .content {padding:1rem;max-width:900px;margin:auto;}
  .card {background:#1e2636;padding:1rem;border-radius:10px;margin:1rem 0;box-shadow:0 0 10px rgba(0,0,0,0.3);}
  .card h2 {color:#00b2ff;margin-bottom:0.3rem;}
  .card h4 {margin:0.4rem 0;color:#bbb;}
  .card iframe {width:100%;height:350px;border:none;border-radius:8px;margin-top:0.8rem;}
  .exam-btn {background:#00b2ff;color:#fff;padding:0.6rem 1rem;border-radius:8px;margin-top:0.8rem;display:inline-block;text-decoration:none;}
  .exam-btn.disabled {background:#555;cursor:not-allowed;opacity:0.6;}
  .score-btn {background:#0077ff;color:#fff;padding:0.6rem 1rem;border-radius:8px;margin:0.8rem 0 0 0.6rem;display:inline-block;text-decoration:none;}
</style>
</head>
<body>
  <header>
    <h1>ğŸ“˜ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ÙƒÙˆØ±Ø³</h1>
    <button class="back">Ø±Ø¬ÙˆØ¹</button>
  </header>

  <div class="content">
    <div id="contentArea">â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰...</div>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyDW80ZbwOB7QHHW76kSL9cqlzMoyPFZ7nI",
  authDomain: "ylearn-fe1fa.firebaseapp.com",
  databaseURL: "https://ylearn-fe1fa-default-rtdb.firebaseio.com",
  projectId: "ylearn-fe1fa",
  storageBucket: "ylearn-fe1fa.firebasestorage.app",
  messagingSenderId: "1092852055944",
  appId: "1:1092852055944:web:85c3df7cf4c0cbcdca043d"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);
const contentArea = document.getElementById("contentArea");

const urlParams = new URLSearchParams(window.location.search);
const selectedCourseId = urlParams.get("courseId") || localStorage.getItem("selectedCourseId");
if (selectedCourseId) localStorage.setItem("selectedCourseId", selectedCourseId);

// ğŸ”¹ ØªØµØ­ÙŠØ­ Ø±ÙˆØ§Ø¨Ø· ÙŠÙˆØªÙŠÙˆØ¨
function fixYouTubeLink(url) {
  if (!url) return "";
  url = url.replace("m.youtube.com", "www.youtube.com");
  let videoId = "";
  if (url.includes("watch?v=")) {
    videoId = url.split("watch?v=")[1].split("&")[0];
  } else if (url.includes("youtu.be/")) {
    videoId = url.split("youtu.be/")[1].split("?")[0];
  } else if (url.includes("/embed/")) {
    return url;
  }
  return `https://www.youtube.com/embed/${videoId}`;
}

// âœ… Ø¬Ù„Ø¨ Ù†ØªÙŠØ¬Ø© Ø§Ù…ØªØ­Ø§Ù†
async function getResult(itemId, userId) {
  const resultSnap = await get(ref(db, `results/${userId}/${itemId}`));
  return resultSnap.exists() ? resultSnap.val() : null;
}

// âœ… Ø¬Ù„Ø¨ Ù†ØªÙŠØ¬Ø© ÙˆØ§Ø¬Ø¨
async function getHomeworkResult(homeworkId, userId) {
  const hwSnap = await get(ref(db, `homeworkResult/${userId}/${homeworkId}`));
  return hwSnap.exists() ? hwSnap.val() : null;
}

onAuthStateChanged(auth, async (user) => {
  if (!user) {
    contentArea.innerHTML = "<p>âš ï¸ ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­ØªÙˆÙ‰.</p>";
    return;
  }

  if (!selectedCourseId) {
    contentArea.innerHTML = "<p>âŒ Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ ÙƒÙˆØ±Ø³.</p>";
    return;
  }

  const snap = await get(ref(db, `courses/${selectedCourseId}/content`));
  if (!snap.exists()) {
    contentArea.innerHTML = "<p>âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø­ØªÙˆÙ‰ Ø¨Ø¹Ø¯.</p>";
    return;
  }

  contentArea.innerHTML = "";
  const allContent = Object.entries(snap.val());
  const lessons = allContent.filter(([_, item]) => item.type === "Ø´Ø±Ø­");
  const exams = allContent.filter(([_, item]) => item.type === "Ø§Ù…ØªØ­Ø§Ù†");
  const homeworks = allContent.filter(([_, item]) => item.type === "ÙˆØ§Ø¬Ø¨");

  // ğŸ“š Ù‚Ø³Ù… Ø§Ù„Ø´Ø±ÙˆØ­Ø§Øª
  if (lessons.length) {
    const h = document.createElement("h2");
    h.textContent = "ğŸ“š Ù‚Ø³Ù… Ø§Ù„Ø´Ø±ÙˆØ­Ø§Øª";
    contentArea.appendChild(h);
    lessons.forEach(([id, item]) => {
      const div = document.createElement("div");
      div.className = "card";
      const videoUrl = fixYouTubeLink(item.video);
      div.innerHTML = `
        <h2>ğŸ“– ${item.title}</h2>
        ${item.note ? `<h4>${item.note}</h4>` : ""}
        ${videoUrl ? `<iframe src="${videoUrl}" allowfullscreen></iframe>` : ""}
      `;
      contentArea.appendChild(div);
    });
  }

  // âœ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù‡Ù„ Ø§Ù„Ø·Ø§Ù„Ø¨ Ø­Ù„ ÙƒÙ„ Ø§Ù„ÙˆØ§Ø¬Ø¨Ø§Øª
  let allHomeworksSolved = true;
  for (const [id] of homeworks) {
    const result = await getHomeworkResult(id, user.uid);
    if (!result) {
      allHomeworksSolved = false;
      break;
    }
  }

  // ğŸ§© Ù‚Ø³Ù… Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª
  if (exams.length) {
    const h = document.createElement("h2");
    h.textContent = "ğŸ§© Ù‚Ø³Ù… Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª";
    contentArea.appendChild(h);
    for (const [id, item] of exams) {
      const div = document.createElement("div");
      div.className = "card";
      const result = await getResult(id, user.uid);
      let buttonsHTML = "";

      if (!allHomeworksSolved) {
        // Ø§Ù„ÙˆØ§Ø¬Ø¨Ø§Øª Ù„Ù… ØªÙØ­Ù„ Ø¨Ø¹Ø¯
        buttonsHTML = `<button class="exam-btn disabled" disabled>âš ï¸ Ø£ÙƒÙ…Ù„ Ø§Ù„ÙˆØ§Ø¬Ø¨Ø§Øª Ø£ÙˆÙ„Ø§Ù‹</button>`;
      } else if (result) {
        buttonsHTML = `
          <button class="exam-btn disabled" disabled>âœ… ØªÙ… Ø§Ù„Ø­Ù„</button>
          <button class="score-btn" onclick="alert('ğŸ¯ Ø¯Ø±Ø¬ØªÙƒ: ${result.score || 0} / ${result.total || 0}\\nâ±ï¸ Ø§Ù„ÙˆÙ‚Øª: ${result.timeTakenMin || 0} Ø¯Ù‚ÙŠÙ‚Ø©')">ğŸ“Š Ø¹Ø±Ø¶ Ø§Ù„Ø¯Ø±Ø¬Ø©</button>
        `;
      } else {
        buttonsHTML = `<a href="exam.html?examId=${id}&courseId=${selectedCourseId}" class="exam-btn">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†</a>`;
      }

      div.innerHTML = `
        <h2>ğŸ“ ${item.title}</h2>
        ${item.desc ? `<h4>${item.desc}</h4>` : ""}
        ${item.time ? `<p>â±ï¸ Ø§Ù„Ù…Ø¯Ø©: ${item.time} Ø¯Ù‚ÙŠÙ‚Ø©</p>` : ""}
        ${buttonsHTML}
      `;
      contentArea.appendChild(div);
    }
  }

  // ğŸ  Ù‚Ø³Ù… Ø§Ù„ÙˆØ§Ø¬Ø¨Ø§Øª
  if (homeworks.length) {
    const h = document.createElement("h2");
    h.textContent = "ğŸ“˜ Ù‚Ø³Ù… Ø§Ù„ÙˆØ§Ø¬Ø¨Ø§Øª";
    contentArea.appendChild(h);
    for (const [id, item] of homeworks) {
      const div = document.createElement("div");
      div.className = "card";
      const result = await getHomeworkResult(id, user.uid);
      let buttonsHTML = "";
      if (result) {
        buttonsHTML = `
          <button class="exam-btn disabled" disabled>âœ… ØªÙ… Ø§Ù„Ø­Ù„</button>
          <button class="score-btn" onclick="alert('ğŸ“Š Ø§Ù„Ø¯Ø±Ø¬Ø©: ${result.percentage || 0}%\\nØ§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø©: ${result.correct || 0}\\nØ§Ù„ÙˆÙ‚Øª: ${result.timeTakenMin || 0} Ø¯Ù‚ÙŠÙ‚Ø©')">Ø¹Ø±Ø¶ Ø§Ù„Ø¯Ø±Ø¬Ø©</button>
        `;
      } else {
        buttonsHTML = `<a href="wageb.html?homeworkId=${id}&courseId=${selectedCourseId}" class="exam-btn" onclick="localStorage.setItem('currentHomeworkId', '${id}')">Ø­Ù„ Ø§Ù„ÙˆØ§Ø¬Ø¨</a>`;
      }

      div.innerHTML = `
        <h2>ğŸ“š ${item.title}</h2>
        ${item.desc ? `<h4>${item.desc}</h4>` : ""}
        ${item.time ? `<p>â±ï¸ Ø§Ù„Ù…Ø¯Ø©: ${item.time} Ø¯Ù‚ÙŠÙ‚Ø©</p>` : ""}
        ${buttonsHTML}
      `;
      contentArea.appendChild(div);
    }
  }
});

// ğŸ”™ Ø²Ø± Ø§Ù„Ø±Ø¬ÙˆØ¹
document.querySelector(".back").addEventListener("click", () => {
  window.location.href = "dashboard.html";
});
</script>
</body>
</html>
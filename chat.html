<!DOCTYPE html><html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ÙˆØ§ØªØ³Ø§Ø¨ Ø±Ù†ÙˆØ¯ØªÙŠğŸ¤©</title>
<style>
  body {
    margin: 0; padding: 0; font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; background:#ece5dd;
  }
  #app {
    max-width: 600px;
    margin: 0 auto;
    height: 100vh;
    display: flex;
    flex-direction: column;
    border: 1px solid #ddd;
    background: #fff;
  }
  header {
    background: #075e54;
    color: white;
    padding: 15px;
    font-size: 20px;
    text-align: center;
    position: relative;
  }
  #clearBtn {
    position: absolute;
    left: 15px;
    top: 15px;
    background: transparent;
    border: none;
    color: white;
    font-size: 18px;
    cursor: pointer;
    opacity: 0.8;
  }
  #clearBtn:hover {
    opacity: 1;
  }
  #messages {
    flex-grow: 1;
    overflow-y: auto;
    padding: 10px;
    background: #ece5dd;
    display: flex;
    flex-direction: column;
  }
  .message {
    max-width: 75%;
    padding: 8px 14px;
    margin: 6px 0;
    border-radius: 20px;
    position: relative;
    font-size: 16px;
    word-wrap: break-word;
    box-shadow: 0 1px 1px rgb(0 0 0 / 0.1);
    display: inline-block;
    user-select: none;
  }
  .sent {
    background: #dcf8c6;
    align-self: flex-end;
    border-bottom-right-radius: 4px;
    text-align: right;
  }
  .received {
    background: white;
    align-self: flex-start;
    border-bottom-left-radius: 4px;
    text-align: left;
  }
  .timestamp {
    font-size: 11px;
    color: gray;
    margin-top: 4px;
    opacity: 0.7;
    user-select: none;
  }
  .message img {
    max-width: 250px;
    border-radius: 15px;
    cursor: pointer;
    display: block;
    margin-bottom: 5px;
    transition: transform 0.3s ease;
  }
  .message img:hover {
    transform: scale(1.05);
  }
  footer {
    padding: 10px 12px;
    display: flex;
    border-top: 1px solid #ccc;
    background: #f0f0f0;
    align-items: center;
  }
  #inputMsg {
    flex-grow: 1;
    border: none;
    border-radius: 20px;
    padding: 10px 15px;
    font-size: 16px;
    outline: none;
    background: white;
    box-shadow: inset 0 1px 2px rgb(0 0 0 / 0.1);
  }
  #sendBtn, #imgBtn, #voiceBtn, #stopVoiceBtn {
    background: #25d366;
    border: none;
    border-radius: 50%;
    color: white;
    width: 44px;
    height: 44px;
    margin-left: 10px;
    cursor: pointer;
    font-size: 22px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 5px rgb(0 0 0 / 0.2);
    transition: background-color 0.2s ease;
  }
  #sendBtn:hover, #imgBtn:hover, #voiceBtn:hover, #stopVoiceBtn:hover {
    background: #128c4a;
  }
  #stopVoiceBtn {
    display: none;
  }
  #noMessages {
    text-align: center;
    color: #777;
    margin-top: 50px;
    font-size: 18px;
  }
  #messageOptions {
    position: fixed;
    background: white;
    border: 1px solid #ccc;
    box-shadow: 0 3px 8px rgba(0,0,0,0.2);
    border-radius: 8px;
    z-index: 1000;
    display: none;
    font-size: 14px;
    direction: rtl;
  }
  #messageOptions button {
    border: none;
    background: none;
    padding: 8px 15px;
    width: 100%;
    cursor: pointer;
    text-align: right;
  }
  #messageOptions button:hover {
    background: #eee;
  }
  audio {
    max-width: 250px;
    border-radius: 15px;
  }
</style>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
  import { getDatabase, ref, push, onChildAdded, remove, update } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-database.js";
  import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDpUU0UTGAD_6T1S_kECThvCf0edKVtuxY",
    authDomain: "girls-dress-up.firebaseapp.com",
    databaseURL: "https://girls-dress-up-default-rtdb.firebaseio.com",
    projectId: "girls-dress-up",
    storageBucket: "girls-dress-up.appspot.com",
    messagingSenderId: "1079086890224",
    appId: "1:1079086890224:web:b1c10c0f64478f7e175635",
    measurementId: "G-B5CXMLTZ6B"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const storage = getStorage(app);

  window.addEventListener('DOMContentLoaded', () => {
    const messagesDiv = document.getElementById("messages");
    const inputMsg = document.getElementById("inputMsg");
    const sendBtn = document.getElementById("sendBtn");
    const imgBtn = document.getElementById("imgBtn");
    const clearBtn = document.getElementById("clearBtn");
    const noMessages = document.getElementById("noMessages");

    const voiceBtn = document.createElement("button");
    voiceBtn.id = "voiceBtn";
    voiceBtn.title = "ØªØ³Ø¬ÙŠÙ„ ØµÙˆØªÙŠ";
    voiceBtn.setAttribute("aria-label", "ØªØ³Ø¬ÙŠÙ„ ØµÙˆØªÙŠ");
    voiceBtn.innerHTML = `
      <svg xmlns="http://www.w3.org/2000/svg" fill="white" viewBox="0 0 24 24" width="22" height="22">
        <path d="M12 14a3 3 0 0 0 3-3V5a3 3 0 0 0-6 0v6a3 3 0 0 0 3 3zm5-3a5 5 0 0 1-10 0H5a7 7 0 0 0 14 0h-2zM12 19a7 7 0 0 0 7-7h-2a5 5 0 0 1-10 0H5a7 7 0 0 0 7 7z"/>
      </svg>
    `;
    const stopVoiceBtn = document.createElement("button");
    stopVoiceBtn.id = "stopVoiceBtn";
    stopVoiceBtn.title = "Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„ØµÙˆØª";
    stopVoiceBtn.setAttribute("aria-label", "Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„ØµÙˆØª");
    stopVoiceBtn.innerHTML = `
      <svg xmlns="http://www.w3.org/2000/svg" fill="white" viewBox="0 0 24 24" width="22" height="22">
        <rect x="6" y="6" width="12" height="12" rx="2" ry="2"/>
      </svg>
    `;

    const footer = document.querySelector("footer");
    footer.insertBefore(voiceBtn, sendBtn);
    footer.insertBefore(stopVoiceBtn, sendBtn);

    let mediaRecorder;
    let audioChunks = [];

    voiceBtn.onclick = async () => {
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        alert("Ø¬Ù‡Ø§Ø²Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØª.");
        return;
      }
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];

        mediaRecorder.ondataavailable = e => {
          audioChunks.push(e.data);
        };

        mediaRecorder.onstop = () => {
          const audioBlob = new Blob(audioChunks, { type: 'audio/ogg; codecs=opus' });
          uploadAudio(audioBlob);
        };

        mediaRecorder.start();
        voiceBtn.style.display = "none";
        stopVoiceBtn.style.display = "flex";
      } catch (err) {
        alert("ØªØ¹Ø°Ø± Ø¨Ø¯Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„: " + err.message);
      }
    };

    stopVoiceBtn.onclick = () => {
      if (mediaRecorder && mediaRecorder.state !== "inactive") {
        mediaRecorder.stop();
        stopVoiceBtn.style.display = "none";
        voiceBtn.style.display = "flex";
      }
    };

    function uploadAudio(blob) {
      const audioRef = sRef(storage, 'audio/' + Date.now() + '.ogg');
      uploadBytes(audioRef, blob).then(() => {
        getDownloadURL(audioRef).then(url => {
          sendMessage({ type: 'audio', content: url });
        }).catch(() => alert("ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØª."));
      }).catch(() => alert("ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„ØµÙˆØª."));
    }

    const chatId = localStorage.getItem("chatId") || prompt("Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© (Ø±Ù‚Ù…ÙŠÙ† ÙÙ‚Ø·):");
    if (!chatId) {
      alert("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø¨Ø¯Ø¡ Ø¨Ø¯ÙˆÙ† Ø±Ù‚Ù… Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©.");
      return;
    }
    localStorage.setItem("chatId", chatId);

    const messagesRef = ref(db, 'chats/' + chatId);

    function formatTime(timestamp) {
      const date = new Date(timestamp);
      return date.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });
    }

    function createMessageElement(id, msg) {
      const div = document.createElement("div");
      div.classList.add("message");
      div.dataset.id = id;

      if (msg.sender === localStorage.getItem("userId")) {
        div.classList.add("sent");
      } else {
        div.classList.add("received");
      }

      if (msg.type === "text") {
        div.textContent = msg.content;
      } else if (msg.type === "image") {
        const img = document.createElement("img");
        img.src = msg.content;
        img.alt = "ØµÙˆØ±Ø© Ù…Ø±Ø³Ù„Ø©";
        div.appendChild(img);
      } else if (msg.type === "audio") {
        const audio = document.createElement("audio");
        audio.controls = true;
        audio.src = msg.content;
        div.appendChild(audio);
      }

      const ts = document.createElement("div");
      ts.classList.add("timestamp");
      ts.textContent = formatTime(msg.timestamp);
      div.appendChild(ts);

      // Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø©
      div.addEventListener("contextmenu", e => {
        e.preventDefault();
        showMessageOptions(e.pageX, e.pageY, id, msg);
      });

      return div;
    }

    function scrollToBottom() {
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    onChildAdded(messagesRef, (data) => {
      noMessages.style.display = "none";
      const msg = data.val();
      const id = data.key;
      const msgElem = createMessageElement(id, msg);
      messagesDiv.appendChild(msgElem);
      scrollToBottom();
    });

    function sendMessage(message) {
      if (!message.content) return;
      const userId = localStorage.getItem("userId") || Math.random().toString(36).substr(2, 9);
      localStorage.setItem("userId", userId);

      const newMsg = {
        sender: userId,
        timestamp: Date.now(),
        type: message.type || "text",
        content: message.content
      };

      push(messagesRef, newMsg).catch(() => alert("ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©."));
    }

    sendBtn.onclick = () => {
      const text = inputMsg.value.trim();
      if (!text) return;
      sendMessage({ type: "text", content: text });
      inputMsg.value = "";
      inputMsg.focus();
    };

    inputMsg.addEventListener("keydown", e => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendBtn.click();
      }
    });

    imgBtn.onclick = () => {
      const fileInput = document.createElement("input");
      fileInput.type = "file";
      fileInput.accept = "image/*";
      fileInput.click();
      fileInput.onchange = () => {
        const file = fileInput.files[0];
        if (!file) return;
        if (!file.type.startsWith("image/")) {
          alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù ØµÙˆØ±Ø© ÙÙ‚Ø·.");
          return;
        }
        const storageRef = sRef(storage, "images/" + Date.now() + "_" + file.name);
        uploadBytes(storageRef, file).then(() => {
          getDownloadURL(storageRef).then(url => {
            sendMessage({ type: "image", content: url });
          }).catch(() => alert("ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø©."));
        }).catch(() => alert("ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©."));
      };
    };

    clearBtn.onclick = () => {
      if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©ØŸ")) {
        remove(messagesRef).then(() => {
          messagesDiv.innerHTML = "";
          noMessages.style.display = "block";
        }).catch(() => alert("ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ø¦Ù„."));
      }
    };

    // Ø®ÙŠØ§Ø±Ø§Øª Ø±Ø³Ø§Ù„Ø©: Ø­Ø°Ù ÙˆØªØ¹Ø¯ÙŠÙ„
    const optionsBox = document.createElement("div");
    optionsBox.id = "messageOptions";
    document.body.appendChild(optionsBox);

    function showMessageOptions(x, y, msgId, msg) {
      optionsBox.innerHTML = "";

      const deleteBtn = document.createElement("button");
      deleteBtn.textContent = "Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø©";
      deleteBtn.onclick = () => {
        remove(ref(db, 'chats/' + chatId + '/' + msgId)).catch(() => alert("ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø©."));
        optionsBox.style.display = "none";
      };
      optionsBox.appendChild(deleteBtn);

      if (msg.sender === localStorage.getItem("userId") && msg.type === "text") {
        const editBtn = document.createElement("button");
        editBtn.textContent = "ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©";
        editBtn.onclick = () => {
          const newText = prompt("Ø¹Ø¯Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©:", msg.content);
          if (newText !== null && newText.trim() !== "") {
            update(ref(db, 'chats/' + chatId + '/' + msgId), { content: newText.trim() }).catch(() => alert("ÙØ´Ù„ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©."));
          }
          optionsBox.style.display = "none";
        };
        optionsBox.appendChild(editBtn);
      }

      optionsBox.style.top = y + "px";
      optionsBox.style.left = x + "px";
      optionsBox.style.display = "block";
    }

    window.onclick = (e) => {
      if (!optionsBox.contains(e.target)) {
        optionsBox.style.display = "none";
      }
    };

  });
</script>
</head>
<body>
  <div id="app">
    <header>
      ÙˆØ§ØªØ³Ø§Ø¨ Ø±Ù†ÙˆØ¯ØªÙŠğŸ¤©
      <button id="clearBtn" title="Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„">Ã—</button>
    </header>
    <div id="messages">
      <div id="noMessages">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ Ø¨Ø¹Ø¯</div>
    </div>
    <footer>
      <input type="text" id="inputMsg" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." autocomplete="off" />
      <button id="sendBtn" title="Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©">
        <svg xmlns="http://www.w3.org/2000/svg" fill="white" viewBox="0 0 24 24" width="22" height="22"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
      </button>
    </footer>
  </div>
</body>
</html>
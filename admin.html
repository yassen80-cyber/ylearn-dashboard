<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø£Ø¯Ù…Ù† | YLEARN</title>
<style>
:root {
  --bg: #0b0f19;
  --card: #111827;
  --accent: #00b2ff;
  --ok: #00b258;
  --danger: #e63946;
  --muted: #ccc;
}
body {
  background: var(--bg);
  color: #fff;
  font-family: "Cairo", sans-serif;
  margin: 0;
  padding: 2rem;
}
h1 {
  text-align: center;
  color: var(--accent);
}
.dashboard {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px,1fr));
  gap: 1.5rem;
  margin-top: 2rem;
}
.card {
  background: var(--card);
  border-radius: 15px;
  padding: 2rem;
  text-align: center;
  transition: 0.3s;
  cursor: pointer;
}
.card:hover {
  transform: scale(1.05);
  background: #131c2a;
}
.card h2 { color: var(--accent); }
.card p { color: var(--muted); }

#notifBtn {
  position: fixed;
  top: 20px;
  left: 20px;
  background: var(--accent);
  border: none;
  border-radius: 50%;
  width: 50px;
  height: 50px;
  color: #fff;
  font-size: 22px;
  cursor: pointer;
}
#notifBtn span {
  position: absolute;
  top: -5px;
  right: -5px;
  background: #e63946;
  border-radius: 50%;
  font-size: 12px;
  padding: 3px 6px;
}
.modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  display: none;
  align-items: center;
  justify-content: center;
}
.modal .box {
  background: var(--card);
  border-radius: 12px;
  padding: 1.5rem;
  width: 90%;
  max-width: 500px;
}
.req {
  background: #1e2636;
  border-radius: 10px;
  padding: 10px;
  margin: 10px 0;
}
.req p { margin: 6px 0; color: var(--muted); }
.unlock-btn {
  background: var(--ok);
  border: none;
  padding: 8px 14px;
  border-radius: 8px;
  color: #fff;
  cursor: pointer;
}
</style>
</head>
<body>
  <button id="notifBtn">ğŸ””<span id="notifCount" style="display:none;">0</span></button>
  <h1>ğŸ‘¨â€ğŸ’» Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø£Ø¯Ù…Ù†</h1>

  <div class="dashboard">
    <div class="card" onclick="window.location.href='teachers.html'">
      <h2>ğŸ‘¨â€ğŸ« Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠÙ†</h2><p>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠÙ†</p>
    </div>
    <div class="card" onclick="window.location.href='courses.html'">
      <h2>ğŸ“š Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª</h2><p>Ø¥Ø¶Ø§ÙØ© Ø£Ùˆ Ø­Ø°Ù ÙƒÙˆØ±Ø³Ø§Øª</p>
    </div>
    <div class="card" onclick="window.location.href='content.html'">
      <h2>ğŸ“– Ø§Ù„Ù…Ø­ØªÙˆÙ‰</h2><p>Ø±ÙØ¹ Ø§Ù„Ø¯Ø±ÙˆØ³ ÙˆØ§Ù„Ù…ÙˆØ§Ø¯</p>
    </div>
  </div>
  
<button class="btn-logout" id="logoutBtn">ğŸ”’ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>

<style>
.btn-logout {
  display: block;
  margin: 2rem auto;
  padding: 12px 26px;
  font-family: "Cairo", sans-serif;
  font-size: 1.05rem;
  font-weight: 600;
  color: #fff;
  background: linear-gradient(45deg, #e63946, #b91c1c);
  border: none;
  border-radius: 12px;
  cursor: pointer;
  box-shadow: 0 4px 15px rgba(230, 57, 70, 0.4);
  transition: all 0.25s ease-in-out;
}
.btn-logout:hover {
  transform: scale(1.07);
  background: linear-gradient(45deg, #ef4444, #991b1b);
  box-shadow: 0 6px 20px rgba(239, 68, 68, 0.5);
}
</style>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getAuth, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDW80ZbwOB7QHHW76kSL9cqlzMoyPFZ7nI",
    authDomain: "ylearn-fe1fa.firebaseapp.com",
    databaseURL: "https://ylearn-fe1fa-default-rtdb.firebaseio.com",
    projectId: "ylearn-fe1fa",
    storageBucket: "ylearn-fe1fa.appspot.com",
    messagingSenderId: "1092852055944",
    appId: "1:1092852055944:web:85c3df7cf4c0cbcdca043d"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);

  document.getElementById("logoutBtn").addEventListener("click", async () => {
    try {
      await signOut(auth);
      alert("âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­");
      window.location.href = "login.html";
    } catch (error) {
      alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬: " + error.message);
    }
  });
</script>

  <div id="notifModal" class="modal">
    <div class="box">
      <h3>ğŸ“© Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø´Ø±Ø§Ø¡</h3>
      <div id="requestsList"></div>
      <button onclick="closeModal()" style="background:#e63946;padding:8px 14px;border:none;border-radius:8px;color:#fff;">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getDatabase, ref, onValue, get, update } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDW80ZbwOB7QHHW76kSL9cqlzMoyPFZ7nI",
      authDomain: "ylearn-fe1fa.firebaseapp.com",
      databaseURL: "https://ylearn-fe1fa-default-rtdb.firebaseio.com",
      projectId: "ylearn-fe1fa",
      storageBucket: "ylearn-fe1fa.appspot.com",
      messagingSenderId: "1092852055944",
      appId: "1:1092852055944:web:85c3df7cf4c0cbcdca043d"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const notifBtn = document.getElementById('notifBtn');
    const notifModal = document.getElementById('notifModal');
    const notifCount = document.getElementById('notifCount');
    const requestsList = document.getElementById('requestsList');

    notifBtn.addEventListener('click', () => notifModal.style.display = 'flex');
    window.closeModal = () => notifModal.style.display = 'none';

    // Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    onValue(ref(db, 'unlockRequests'), async (snap) => {
      requestsList.innerHTML = '';
      if (!snap.exists()) {
        requestsList.innerHTML = '<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹.</p>';
        notifCount.style.display = 'none';
        return;
      }

      const all = snap.val();
      let count = 0;

      for (const [reqId, req] of Object.entries(all)) {
        if (req.status === 'pending') count++;

        // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨ Ù…Ù† users
        const userSnap = await get(ref(db, `users/${req.studentId}`));
        let student = userSnap.exists() ? userSnap.val() : {};

        const div = document.createElement('div');
        div.className = 'req';
        div.innerHTML = `
          <p>ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…: ${student.fullName || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</p>
          <p>ğŸ“ Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨: ${student.studentNumber || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</p>
          <p>ğŸ‘¨â€ğŸ‘©â€ğŸ‘¦ Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±: ${student.parentNumber || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</p>
          <p>ğŸ“˜ Ø§Ù„ÙƒÙˆØ±Ø³: ${req.courseName}</p>
          <p>ğŸ“… ${new Date(req.timestamp).toLocaleString('ar-EG')}</p>
          ${req.status === 'pending'
            ? `<button class="unlock-btn" data-id="${reqId}">ğŸ”“ ÙÙƒ Ø§Ù„Ù‚ÙÙ„</button>`
            : '<p style="color:#00b258;">âœ… ØªÙ… Ø§Ù„ÙØªØ­</p>'}
        `;
        requestsList.appendChild(div);
      }

      notifCount.style.display = count > 0 ? 'inline' : 'none';
      notifCount.textContent = count;

      document.querySelectorAll('.unlock-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          const id = btn.dataset.id;
          const reqSnap = await get(ref(db, `unlockRequests/${id}`));
          if (!reqSnap.exists()) return alert('âŒ Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
          const r = reqSnap.val();

          await update(ref(db, `unlockRequests/${id}`), { status: 'approved' });
          await update(ref(db, `users/${r.studentId}/courses/${r.courseId}`), { unlocked: true });
          alert(`âœ… ØªÙ… ÙÙƒ Ø§Ù„Ù‚ÙÙ„ Ù„Ù„ÙƒÙˆØ±Ø³ "${r.courseName}"`);
          btn.parentElement.innerHTML += '<p style="color:#00b258;">âœ… ØªÙ… Ø§Ù„ÙØªØ­</p>';
          btn.remove();
        });
      });
    });
  </script>
</body>
</html>
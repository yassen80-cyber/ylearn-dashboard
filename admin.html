<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø£Ø¯Ù…Ù† | YLEARN</title>
<link rel="preconnect" href="https://fonts.gstatic.com">
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#0b0f19; --card:#111827; --accent:#00b2ff;
  --ok:#00b258; --danger:#e63946; --muted:#ccc;
}
*{box-sizing:border-box}
body {
  background:var(--bg); color:#fff; font-family:"Cairo",sans-serif;
  margin:0; padding:2rem;
  -webkit-font-smoothing:antialiased;
}
h1{text-align:center;color:var(--accent);margin:0}
.dashboard{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(250px,1fr));
  gap:1.5rem;margin-top:1.4rem;
}
.card{
  background:var(--card);border-radius:15px;padding:1.6rem;text-align:center;
  transition:0.25s;cursor:default;box-shadow:0 6px 20px rgba(2,6,23,0.6);
}
.card:hover{transform:translateY(-4px);background:#131c2a;}
.card h2{color:var(--accent);margin:0 0 .4rem}
.card p{color:var(--muted);margin:0}
#notifBtn{
  position:fixed;top:20px;left:20px;background:var(--accent);
  border:none;border-radius:50%;width:50px;height:50px;
  color:#fff;font-size:22px;cursor:pointer;z-index:60;
}
#notifBtn span{
  position:absolute;top:-5px;right:-5px;background:#e63946;
  border-radius:50%;font-size:12px;padding:3px 6px;
}
.modal{
  position:fixed;inset:0;background:rgba(0,0,0,0.6);
  display:none;align-items:center;justify-content:center;z-index:70;
}
.modal .box{
  background:var(--card);border-radius:12px;
  padding:1.5rem;width:90%;max-width:800px;
}
.tabs {
  display:flex;justify-content:center;margin-bottom:1rem;
}
.tabs button {
  background:#1e2636;color:#fff;border:none;padding:10px 18px;
  cursor:pointer;border-radius:8px;margin:0 5px;
  transition:0.25s;font-weight:bold;
}
.tabs button.active {
  background:var(--accent);color:#000;
}
.tab-content {display:none;}
.tab-content.active {display:block;}
.req{
  background:#0e1721;border-radius:10px;padding:10px;margin:10px 0;
}
.req p{margin:6px 0;color:var(--muted);font-size:0.98rem;}
.clear-btn {
  background:var(--danger);
  color:#fff;border:none;padding:8px 12px;border-radius:8px;
  font-weight:bold;cursor:pointer;margin-top:10px;
}
.clear-btn:hover{background:#c11e2e;}
.btn-logout {
  display:block;margin:2rem auto;padding:12px 26px;
  font-family:"Cairo",sans-serif;font-size:1.05rem;font-weight:600;
  color:#fff;background:linear-gradient(45deg,#e63946,#b91c1c);
  border:none;border-radius:12px;cursor:pointer;
  box-shadow:0 4px 15px rgba(230,57,70,0.4);
  transition:all 0.25s ease-in-out;
}
.btn-logout:hover{
  transform:scale(1.07);
  background:linear-gradient(45deg,#ef4444,#991b1b);
  box-shadow:0 6px 20px rgba(239,68,68,0.5);
}

/* Ø¥Ø¶Ø§ÙØ§Øª ØµÙØ­Ø© dashboard Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ© */
.ext-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); gap:1rem; margin-top:1rem; }
.small-muted { color:var(--muted); font-size:0.95rem; margin-top:6px; }
.messages .msg { background:#08101a; padding:10px; border-radius:8px; margin:8px 0; color:var(--muted); text-align:right; }
.card .kpi { font-size:1.6rem; font-weight:700; color:#fff; margin-top:8px; }
.chart-card { padding:1rem; height:260px; display:flex; flex-direction:column; }
@media (max-width:600px) {
  body{padding:1rem}
  .btn-logout{width:100%}
}
</style>
</head>
<body>
<button id="notifBtn">ğŸ””<span id="notifCount" style="display:none;">0</span></button>
<h1>ğŸ‘¨â€ğŸ’» Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø£Ø¯Ù…Ù†</h1>

<!-- Ø§Ù„Ø£ØµÙ„ÙŠ: Ø§Ù„ÙƒØ±ÙˆØª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
<div class="dashboard">
  <div class="card" onclick="window.location.href='teachers.html'">
    <h2>ğŸ‘¨â€ğŸ« Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠÙ†</h2><p>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠÙ†</p>
  </div>
  <div class="card" onclick="window.location.href='courses.html'">
    <h2>ğŸ“š Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª</h2><p>Ø¥Ø¶Ø§ÙØ© Ø£Ùˆ Ø­Ø°Ù ÙƒÙˆØ±Ø³Ø§Øª</p>
  </div>
  <div class="card" onclick="window.location.href='content.html'">
    <h2>ğŸ“– Ø§Ù„Ù…Ø­ØªÙˆÙ‰</h2><p>Ø±ÙØ¹ Ø§Ù„Ø¯Ø±ÙˆØ³ ÙˆØ§Ù„Ù…ÙˆØ§Ø¯</p>
  </div>
</div>

<button class="btn-logout" id="logoutBtn">ğŸ”’ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>

<!-- Ù†Ø§ØªÙŠÙ Ù…ÙˆØ¯Ø§Ù„ Ù„Ù„Ù€ notifications (Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ø£ØµÙ„ÙŠ) -->
<div id="notifModal" class="modal">
  <div class="box">
    <div class="tabs">
      <button id="tab-requests" class="active">ğŸ“© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</button>
      <button id="tab-reviews">â­ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</button>
    </div>
    <div id="requestsTab" class="tab-content active">
      <div id="requestsList"></div>
      <button class="clear-btn" id="clearNotif">ğŸ—‘ï¸ Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</button>
    </div>
    <div id="reviewsTab" class="tab-content">
      <div id="reviewsList"></div>
      <button class="clear-btn" id="clearReviews">ğŸ—‘ï¸ Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</button>
    </div>
    <button onclick="closeModal()" style="background:#555;padding:8px 14px;border:none;border-radius:8px;color:#fff;margin-top:8px;">Ø¥ØºÙ„Ø§Ù‚</button>
  </div>
</div>

<!-- ---------- Ø³ÙƒØ±Ø¨Øª Firebase Ø§Ù„Ø£ØµÙ„ÙŠ (Auth) ---------- -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
const firebaseConfig = {
  apiKey: "AIzaSyDW80ZbwOB7QHHW76kSL9cqlzMoyPFZ7nI",
  authDomain: "ylearn-fe1fa.firebaseapp.com",
  databaseURL: "https://ylearn-fe1fa-default-rtdb.firebaseio.com",
  projectId: "ylearn-fe1fa",
  storageBucket: "ylearn-fe1fa.appspot.com",
  messagingSenderId: "1092852055944",
  appId: "1:1092852055944:web:85c3df7cf4c0cbcdca043d"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
document.getElementById("logoutBtn").addEventListener("click", async () => {
  try {
    await signOut(auth);
    alert("âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­");
    window.location.href = "login.html";
  } catch (error) {
    alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬: " + error.message);
  }
});
</script>

<!-- ---------- Ø³ÙƒØ±Ø¨Øª Firebase Ø§Ù„Ø£ØµÙ„ÙŠ (Realtime DB - Ø·Ù„Ø¨Ø§Øª Ùˆfeedback) ---------- -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, onValue, set, get, remove } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDW80ZbwOB7QHHW76kSL9cqlzMoyPFZ7nI",
  authDomain: "ylearn-fe1fa.firebaseapp.com",
  databaseURL: "https://ylearn-fe1fa-default-rtdb.firebaseio.com",
  projectId: "ylearn-fe1fa",
  storageBucket: "ylearn-fe1fa.appspot.com",
  messagingSenderId: "1092852055944",
  appId: "1:1092852055944:web:85c3df7cf4c0cbcdca043d"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const notifBtn = document.getElementById('notifBtn');
const notifModal = document.getElementById('notifModal');
const notifCount = document.getElementById('notifCount');
const requestsList = document.getElementById('requestsList');
const reviewsList = document.getElementById('reviewsList');
const clearBtn = document.getElementById('clearNotif');
const clearReviews = document.getElementById('clearReviews');

// Tabs switching
const tabReq = document.getElementById('tab-requests');
const tabRev = document.getElementById('tab-reviews');
const reqTab = document.getElementById('requestsTab');
const revTab = document.getElementById('reviewsTab');
tabReq.addEventListener('click',()=>{
  tabReq.classList.add('active');tabRev.classList.remove('active');
  reqTab.classList.add('active');revTab.classList.remove('active');
});
tabRev.addEventListener('click',()=>{
  tabRev.classList.add('active');tabReq.classList.remove('active');
  revTab.classList.add('active');reqTab.classList.remove('active');
});

notifBtn.addEventListener('click', () => notifModal.style.display = 'flex');
window.closeModal = () => notifModal.style.display = 'none';

// Ù…Ø³Ø­ Ø§Ù„Ø·Ù„Ø¨Ø§Øª
clearBtn.addEventListener('click', async () => {
  if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§ØªØŸ")) {
    await remove(ref(db, 'unlockRequests'));
    requestsList.innerHTML = '<p>ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª âœ…</p>';
    notifCount.style.display = 'none';
  }
});

// Ù…Ø³Ø­ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª
clearReviews.addEventListener('click', async () => {
  if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§ØªØŸ")) {
    await remove(ref(db, 'reviews'));
    reviewsList.innerHTML = '<p>ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª âœ…</p>';
  }
});

// Ø§Ù„Ø£ÙƒÙˆØ§Ø¯
function generateCode(len = 8) {
  const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
  return Array.from({length:len},()=>chars[Math.floor(Math.random()*chars.length)]).join('');
}

onValue(ref(db, 'unlockRequests'), async (snap) => {
  requestsList.innerHTML = '';
  if (!snap.exists()) {
    requestsList.innerHTML = '<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹.</p>';
    notifCount.style.display = 'none';
    return;
  }

  const all = snap.val();
  let count = 0;
  for (const [reqId, req] of Object.entries(all)) {
    const userSnap = await get(ref(db, `users/${req.studentId}`));
    const student = userSnap.exists() ? userSnap.val() : {};
    const codePath = `activationCodes/${req.studentId}_${req.courseId}`;
    const codeSnap = await get(ref(db, codePath));
    let codeData;
    if (!codeSnap.exists()) {
      const newCode = generateCode(8);
      codeData = {
        code: newCode,
        studentName: student.fullName || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ',
        studentNumber: student.studentNumber || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ',
        courseName: req.courseName,
        status: 'unused',
        date: new Date(req.timestamp).toLocaleString('ar-EG')
      };
      await set(ref(db, codePath), codeData);
    } else {
      codeData = codeSnap.val();
    }
    count++;
    const div = document.createElement('div');
    div.className = 'req';
    div.innerHTML = `
      <p>ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…: ${codeData.studentName}</p>
      <p>ğŸ“ Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨: ${codeData.studentNumber}</p>
      <p>ğŸ“˜ Ø§Ù„ÙƒÙˆØ±Ø³: ${codeData.courseName}</p>
      <p>ğŸ“… ${codeData.date}</p>
      <p>ğŸ”‘ <b>ÙƒÙˆØ¯ Ø§Ù„ØªÙØ¹ÙŠÙ„:</b> <span style="color:#00b2ff">${codeData.code}</span></p>
    `;
    requestsList.appendChild(div);
  }

  notifCount.style.display = count > 0 ? 'inline' : 'none';
  notifCount.textContent = count;
});

// Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª (Ø§Ù„Ù„ÙŠ ÙÙŠ notifications/feedbacks)
onValue(ref(db, 'notifications/feedbacks'), (snap) => {
  reviewsList.innerHTML = '';
  if (!snap.exists()) {
    reviewsList.innerHTML = '<p>Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹.</p>';
    return;
  }
  for (const [id, r] of Object.entries(snap.val())) {
    const div = document.createElement('div');
    div.className = 'req';
    div.innerHTML = `
      <p>â­ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…: ${r.rating || '-'}</p>
      <p>ğŸ’¬ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚: ${r.message || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</p>
    `;
    reviewsList.appendChild(div);
  }
});
</script>

<!-- ---------- Ø¥Ø¶Ø§ÙØ§Øª Dashboard: Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¯ØŒ Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©ØŒ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ---------- -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script type="module">
/* Ù†Ù†Ø´Ø¦ Ù†Ø³Ø®Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù…Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù„ØªØ¬Ù†Ø¨ Ø£ÙŠ ØªØ¹Ø§Ø±Ø¶ Ù…Ø¹ Ø§Ù„Ù€ app Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø§Ù„Ù„ÙŠ ÙÙˆÙ‚ */
import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, get, onValue } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDW80ZbwOB7QHHW76kSL9cqlzMoyPFZ7nI",
  authDomain: "ylearn-fe1fa.firebaseapp.com",
  databaseURL: "https://ylearn-fe1fa-default-rtdb.firebaseio.com",
  projectId: "ylearn-fe1fa",
  storageBucket: "ylearn-fe1fa.appspot.com",
  messagingSenderId: "1092852055944",
  appId: "1:1092852055944:web:85c3df7cf4c0cbcdca043d"
};

// Ù„Ùˆ Ù…ÙÙŠØ´ apps Ø¨Ù†ÙØ³ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ù†Ø¹Ù…Ù„ ÙˆØ§Ø­Ø¯Ø© Ù…Ø³Ù…Ø§Ø©
let extApp;
try {
  extApp = initializeApp(firebaseConfig, 'dashboard-ext'); // Ø§Ø³Ù… Ù…Ù…ÙŠØ² Ù„ØªØ¬Ù†Ø¨ ØªÙ‡ÙŠØ¦Ø© Ù…ÙƒØ±Ø±Ø©
} catch(e) {
  // Ù„Ùˆ Ø§ØªØ¹Ù…Ù„Øª Ù‚Ø¨Ù„ ÙƒØ¯Ø§ØŒ Ù†Ø¬ÙŠØ¨Ù‡Ø§ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
  const apps = getApps();
  extApp = apps.find(a=>a.name === 'dashboard-ext') || apps[0];
}
const dbExt = getDatabase(extApp);

/* === Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù€ UI Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ (ÙƒØ±ÙˆØª ÙˆCharts ÙˆØ§Ù„Ø±Ø³Ø§Ø¦Ù„) === */
const extContainer = document.createElement('section');
extContainer.className = 'card';
extContainer.style.marginTop = '1rem';
extContainer.innerHTML = `
  <h2>ğŸ“ˆ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø³Ø±ÙŠØ¹Ø©</h2>
  <div class="ext-grid">
    <div class="card">
      <h2>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h2>
      <div class="kpi" id="usersKPI">--</div>
      <div class="small-muted">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ† ÙÙŠ Ø§Ù„Ù…Ø³Ø§Ø± <code>users</code></div>
    </div>
    <div class="card">
      <h2>Ø¹Ø¯Ø¯ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</h2>
      <div class="kpi" id="reviewsKPI">--</div>
      <div class="small-muted">Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ù…Ù† <code>notifications/feedbacks</code></div>
    </div>
    <div class="card">
      <h2>Ù…ØªÙˆØ³Ø· Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¹Ø§Ù…</h2>
      <div class="kpi" id="avgKPI">--</div>
      <div class="small-muted">Ù…Ø­Ø³ÙˆØ¨ Ù…Ù† Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©</div>
    </div>
    <div class="card">
      <h2>Ø£ÙƒØ«Ø± Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª Ù…Ø´Ø§Ù‡Ø¯Ø©</h2>
      <div id="topCoursesList" class="small-muted">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
    </div>
  </div>

  <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-top:1rem;">
    <div class="card chart-card">
      <h2>ğŸ“Š Ø£ÙƒØ«Ø± 5 ÙƒÙˆØ±Ø³Ø§Øª Ù…Ø´Ø§Ù‡Ø¯Ø©</h2>
      <canvas id="coursesBar"></canvas>
    </div>
    <div class="card chart-card">
      <h2>â­ ØªÙˆØ²ÙŠØ¹ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</h2>
      <canvas id="ratingsDonut"></canvas>
    </div>
  </div>

  <div class="card messages" style="margin-top:1rem;">
    <h2>ğŸ“© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</h2>
    <div id="messagesBox"><p class="small-muted">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p></div>
  </div>
`;
/* Ù†Ø­Ø· Ø§Ù„Ø¥Ø¶Ø§ÙØ© ØªØ­Øª Ø§Ù„Ù€ dashboard Ø§Ù„Ø£ØµÙ„ÙŠ */
document.querySelector('.dashboard')?.insertAdjacentElement('afterend', extContainer);

/* ======== Ø¯ÙˆØ§Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ======== */
async function getUsersCount() {
  try {
    const s = await get(ref(dbExt, 'users'));
    return s.exists() ? Object.keys(s.val()).length : 0;
  } catch(e) { return 0; }
}

async function getReviewsAll() {
  // Ù†Ù‚Ø±Ø£ Ù…Ù† notifications/feedbacks (Ø²ÙŠ Ø§Ù„Ù„ÙŠ Ø¨Ø§Ù„ØµÙˆØ±Ø©)
  try {
    const s = await get(ref(dbExt, 'notifications/feedbacks'));
    return s.exists() ? s.val() : {};
  } catch(e){ return {}; }
}

async function getCoursesAll() {
  try {
    const s = await get(ref(dbExt, 'courses'));
    return s.exists() ? s.val() : {};
  } catch(e){ return {}; }
}

async function getMessagesAll() {
  // Ù†Ø­Ø§ÙˆÙ„ Ø¹Ø¯Ø© Ù…Ø³Ø§Ø±Ø§Øª Ù…Ø¹Ø±ÙˆÙØ©
  const paths = ['messages','notifications/messages','inbox','notifications/inbox'];
  let all = {};
  for (const p of paths) {
    try {
      const s = await get(ref(dbExt, p));
      if (s.exists()) {
        for (const [k,v] of Object.entries(s.val())) all[`${p}/${k}`] = v;
      }
    } catch(e){}
  }
  return all;
}

/* ======== Ø§Ù„Ù…Ù†Ø·Ù‚ Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© ÙˆØ¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ======== */
let barChart = null;
let donutChart = null;

async function refreshDashboard() {
  // Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
  const usersCount = await getUsersCount();
  document.getElementById('usersKPI').textContent = usersCount;

  // ØªÙ‚ÙŠÙŠÙ…Ø§Øª
  const reviewsObj = await getReviewsAll();
  const reviewEntries = Object.values(reviewsObj || {});
  document.getElementById('reviewsKPI').textContent = reviewEntries.length;

  // Ù…ØªÙˆØ³Ø· Ø§Ù„ØªÙ‚ÙŠÙŠÙ… ÙˆØªÙˆØ²ÙŠØ¹
  let sum = 0, cnt = 0;
  const buckets = {5:0,4:0,3:0,2:0,1:0,0:0};
  for (const r of reviewEntries) {
    const val = (r && (r.rating ?? r.rate ?? r.stars ?? r.value)) ?? null;
    const num = val !== null ? Number(val) : NaN;
    if (!isNaN(num)) { sum += num; cnt++; const b = Math.max(1, Math.min(5, Math.round(num))); buckets[b]++; }
    else buckets[0]++;
  }
  document.getElementById('avgKPI').textContent = cnt ? (sum/cnt).toFixed(2) + ' / 5' : 'Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚ÙŠÙŠÙ…Ø§Øª';

  // ÙƒÙˆØ±Ø³Ø§Øª - ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ views
  const coursesObj = await getCoursesAll();
  const arr = [];
  for (const [id, c] of Object.entries(coursesObj || {})) {
    const title = c.title || c.name || c.courseName || id;
    const views = Number(c.views ?? c.viewCount ?? c.viewsCount ?? c.views_number ?? 0) || 0;
    arr.push({id, title, views});
  }
  arr.sort((a,b)=>b.views - a.views);
  const top5 = arr.slice(0,5);
  document.getElementById('topCoursesList').innerHTML = top5.length ? top5.map(x=>`${x.title} â€” ${x.views} Ù…Ø´Ø§Ù‡Ø¯Ø©`).join('<br>') : '<span class="small-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙƒÙˆØ±Ø³Ø§Øª</span>';

  // ØªØ­Ø¯ÙŠØ« Bar chart
  const barCtx = document.getElementById('coursesBar').getContext('2d');
  const labels = top5.map(x=>x.title);
  const data = top5.map(x=>x.views);
  if (barChart) barChart.destroy();
  barChart = new Chart(barCtx, {
    type: 'bar',
    data: { labels, datasets: [{ label:'Ù…Ø´Ø§Ù‡Ø¯Ø§Øª', data, borderWidth:1 }] },
    options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{ y:{ beginAtZero:true } } }
  });

  // Donut chart
  const donutCtx = document.getElementById('ratingsDonut').getContext('2d');
  const donutData = [buckets[5],buckets[4],buckets[3],buckets[2],buckets[1],buckets[0]];
  if (donutChart) donutChart.destroy();
  donutChart = new Chart(donutCtx, {
    type: 'doughnut',
    data: { labels:['5 Ù†Ø¬ÙˆÙ…','4 Ù†Ø¬ÙˆÙ…','3 Ù†Ø¬ÙˆÙ…','2 Ù†Ø¬ÙˆÙ…','1 Ù†Ø¬Ù…Ø©','ØºÙŠØ± Ù…Ù‚ÙŠÙ…'], datasets:[{ data:donutData, borderWidth:1 }] },
    options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'bottom'}} }
  });

  // Ø±Ø³Ø§Ø¦Ù„
  const msgs = await getMessagesAll();
  const msgsArr = Object.values(msgs || {});
  const messagesBox = document.getElementById('messagesBox');
  messagesBox.innerHTML = '';
  if (!msgsArr.length) {
    messagesBox.innerHTML = '<p class="small-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ Ø¬Ø¯ÙŠØ¯Ø©.</p>';
  } else {
    for (const m of msgsArr.slice(0,10)) {
      const content = m.message ?? m.text ?? m.body ?? JSON.stringify(m);
      const from = m.from ?? m.sender ?? m.user ?? m.phone ?? '-';
      const node = document.createElement('div');
      node.className = 'msg';
      node.innerHTML = `<strong>Ù…Ù†: ${from}</strong><p style="margin:6px 0">${String(content).slice(0,240)}</p>`;
      messagesBox.appendChild(node);
    }
  }
}

/* ØªÙ‡ÙŠØ¦Ø© Ø£ÙˆÙ„ÙŠØ© + listeners Ù„Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­ÙŠ */
refreshDashboard().catch(e=>console.error(e));

// Ù†Ø¹Ù…Ù„ listeners Ù„Ù„Ù€ users Ùˆ feedbacks Ù„ØªØ­Ø¯ÙŠØ« ÙÙˆØ±ÙŠ
try {
  onValue(ref(dbExt, 'users'), ()=>{ getUsersCount().then(n=>document.getElementById('usersKPI').textContent = n).catch(()=>{}); });
  onValue(ref(dbExt, 'notifications/feedbacks'), ()=>{ refreshDashboard().catch(()=>{}); });
  // Ù„Ùˆ Ø¹Ù†Ø¯Ùƒ ØªØºÙŠÙŠØ± Ù Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª
  onValue(ref(dbExt, 'courses'), ()=>{ refreshDashboard().catch(()=>{}); });
} catch(e){ /* ignore listener errors */ }

</script>

</body>
</html>